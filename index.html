<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ATRONIA-LIGHT BLE Monitor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #status {
      font-size: 18px;
      margin-top: 10px;
      color: #007BFF;
    }
    .data {
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>ATRONIA-LIGHT BLE Monitor</h1>
  <button id="connectButton">Connect to ATRONIA-LIGHT</button>
  <div id="status">Status: Disconnected</div>
  <div class="data">
    <p><strong>Battery Level:</strong> <span id="batteryLevel">N/A</span>%</p>
    <p><strong>Solar Voltage:</strong> <span id="solarVoltage">N/A</span> V</p>
    <p><strong>LED Status:</strong> <span id="ledStatus">N/A</span></p>
    <p><strong>Charge Status:</strong> <span id="chargeStatus">N/A</span></p>
  </div>
  <script>
    const connectButton = document.getElementById("connectButton");
    const statusDiv = document.getElementById("status");
    const batteryLevelSpan = document.getElementById("batteryLevel");
    const solarVoltageSpan = document.getElementById("solarVoltage");
    const ledStatusSpan = document.getElementById("ledStatus");
    const chargeStatusSpan = document.getElementById("chargeStatus");

    connectButton.addEventListener("click", async () => {
      try {
        statusDiv.textContent = "Status: Connecting...";
        
        // Request device with specific BLE service
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: false,
          filters: [{ name: "ATRONIA-LIGHT" }],
          optionalServices: [
            "0000180f-0000-1000-8000-00805f9b34fb", // Battery Service
            "0000180a-0000-1000-8000-00805f9b34fb"  // Device Info Service
          ]
        });

        const server = await device.gatt.connect();
        statusDiv.textContent = "Status: Connected";

        // Get Battery Service and Characteristics
        const batteryService = await server.getPrimaryService("0000180f-0000-1000-8000-00805f9b34fb");
        const batteryLevelChar = await batteryService.getCharacteristic("00002a19-0000-1000-8000-00805f9b34fb");

        // Get Solar Voltage Characteristic
        const solarService = await server.getPrimaryService("0000180a-0000-1000-8000-00805f9b34fb");
        const solarVoltageChar = await solarService.getCharacteristic("00002a6e-0000-1000-8000-00805f9b34fb");
        const ledStatusChar = await solarService.getCharacteristic("00002a56-0000-1000-8000-00805f9b34fb");
        const chargeStatusChar = await solarService.getCharacteristic("00002a1c-0000-1000-8000-00805f9b34fb");

        // Read and Display Battery Level
        batteryLevelChar.addEventListener("characteristicvaluechanged", (event) => {
          const batteryLevel = event.target.value.getUint8(0);
          batteryLevelSpan.textContent = batteryLevel;
        });
        await batteryLevelChar.startNotifications();

        // Read and Display Solar Voltage
        solarVoltageChar.addEventListener("characteristicvaluechanged", (event) => {
          const solarVoltage = event.target.value.getFloat32(0, true);
          solarVoltageSpan.textContent = solarVoltage.toFixed(2);
        });
        await solarVoltageChar.startNotifications();

        // Read and Display LED Status
        ledStatusChar.addEventListener("characteristicvaluechanged", (event) => {
          const ledStatus = event.target.value.getUint8(0);
          ledStatusSpan.textContent = ledStatus === 0 ? "OFF" : ledStatus === 1 ? "ON" : "FLASHING";
        });
        await ledStatusChar.startNotifications();

        // Read and Display Charge Status
        chargeStatusChar.addEventListener("characteristicvaluechanged", (event) => {
          const chargeStatus = event.target.value.getUint8(0);
          chargeStatusSpan.textContent =
            chargeStatus === 0 ? "Not Charging" : chargeStatus === 1 ? "Charging" : "Floating";
        });
        await chargeStatusChar.startNotifications();

      } catch (error) {
        console.error("Error:", error);
        statusDiv.textContent = "Status: Error - " + error.message;
      }
    });
  </script>
</body>
</html>
